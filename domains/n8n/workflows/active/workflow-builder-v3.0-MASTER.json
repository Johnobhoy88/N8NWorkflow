{
  "name": "n8n Workflow Builder v3.0 MASTER - Production-Ready",
  "nodes": [
    {
      "parameters": {
        "path": "workflow-builder-v3",
        "formTitle": "n8n Workflow Builder v3.0 - Enterprise Edition",
        "formDescription": "Describe your workflow needs and receive a secure, optimized, GDPR-compliant n8n workflow",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Client Brief",
              "fieldType": "textarea",
              "requiredField": true,
              "placeholder": "Describe what you want your workflow to do (10-5000 characters)...",
              "multipleValues": false
            },
            {
              "fieldLabel": "Your Email",
              "fieldType": "email",
              "requiredField": true,
              "placeholder": "your@email.com"
            },
            {
              "fieldLabel": "GDPR Consent",
              "fieldType": "dropdown",
              "requiredField": true,
              "placeholder": "I consent to data processing",
              "options": [
                {
                  "name": "Yes - I consent to data processing as per privacy policy",
                  "value": "yes"
                },
                {
                  "name": "No - I do not consent",
                  "value": "no"
                }
              ]
            },
            {
              "fieldLabel": "Organization (Optional)",
              "fieldType": "text",
              "requiredField": false,
              "placeholder": "Your company name"
            },
            {
              "fieldLabel": "Priority",
              "fieldType": "dropdown",
              "requiredField": false,
              "placeholder": "Standard",
              "options": [
                {
                  "name": "Standard",
                  "value": "standard"
                },
                {
                  "name": "High",
                  "value": "high"
                }
              ]
            }
          ]
        },
        "responseMode": "onReceived",
        "options": {
          "respondWithOptions": {
            "values": {
              "responseHeaders": {
                "values": {
                  "entries": [
                    {
                      "name": "X-Frame-Options",
                      "value": "DENY"
                    },
                    {
                      "name": "X-Content-Type-Options",
                      "value": "nosniff"
                    },
                    {
                      "name": "Content-Security-Policy",
                      "value": "default-src 'self'"
                    },
                    {
                      "name": "Strict-Transport-Security",
                      "value": "max-age=31536000; includeSubDomains"
                    }
                  ]
                }
              }
            }
          }
        }
      },
      "id": "form-trigger-v3",
      "name": "Form Trigger v3",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.1,
      "position": [100, 300],
      "webhookId": "workflow-builder-v3"
    },
    {
      "parameters": {
        "jsCode": "// GDPR Compliance Check with enhanced security\nconst consent = $input.first().json[\"GDPR Consent\"];\n\nif (consent !== \"yes\") {\n  return [{\n    json: {\n      error: true,\n      fatal: true,\n      message: \"GDPR consent is required to process your request\",\n      timestamp: new Date().toISOString(),\n      stage: \"consent-validation\"\n    }\n  }];\n}\n\n// Validate and normalize input data with security measures\nconst input = $input.first().json;\nconst errors = [];\n\n// Enhanced input validation\nconst clientBrief = String(input[\"Client Brief\"] || \"\").trim();\nconst clientEmail = String(input[\"Your Email\"] || \"\").trim().toLowerCase();\nconst organization = String(input[\"Organization (Optional)\"] || \"\").trim();\nconst priority = String(input[\"Priority\"] || \"standard\").toLowerCase();\n\n// Security validations\nif (clientBrief.length < 10) {\n  errors.push(\"Client brief must be at least 10 characters\");\n}\nif (clientBrief.length > 5000) {\n  errors.push(\"Client brief must not exceed 5000 characters\");\n}\n\n// Enhanced email validation\nconst emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\nif (!emailRegex.test(clientEmail)) {\n  errors.push(\"Invalid email format\");\n}\n\n// Check for potential injection attempts\nconst dangerousPatterns = [\n  /<script/i,\n  /javascript:/i,\n  /onclick/i,\n  /onerror/i,\n  /SELECT.*FROM/i,\n  /DROP.*TABLE/i,\n  /INSERT.*INTO/i,\n  /UPDATE.*SET/i\n];\n\nfor (const pattern of dangerousPatterns) {\n  if (pattern.test(clientBrief) || pattern.test(organization)) {\n    errors.push(\"Potentially dangerous content detected\");\n    break;\n  }\n}\n\nif (errors.length > 0) {\n  return [{\n    json: {\n      error: true,\n      fatal: true,\n      errorMessages: errors,\n      message: errors.join(\"; \"),\n      timestamp: new Date().toISOString(),\n      stage: \"input-validation\",\n      clientEmail: clientEmail\n    }\n  }];\n}\n\n// Generate unique workflow ID for tracking\nconst workflowId = `wf_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n\n// Create data envelope with all context (Data Flow Pattern)\nconst dataEnvelope = {\n  // Core data\n  clientBrief: clientBrief,\n  clientEmail: clientEmail,\n  organization: organization,\n  priority: priority,\n  \n  // Metadata\n  workflowId: workflowId,\n  timestamp: new Date().toISOString(),\n  source: \"form\",\n  version: \"3.0\",\n  \n  // GDPR compliance\n  gdprConsent: {\n    given: true,\n    timestamp: new Date().toISOString(),\n    version: \"1.0\",\n    ip: $input.first().json.$request?.ip || \"unknown\",\n    userAgent: $input.first().json.$request?.userAgent || \"unknown\"\n  },\n  \n  // Processing metadata\n  processingStages: [\"input-validation\"],\n  retentionDays: 30,\n  \n  // Security context\n  securityChecks: {\n    inputSanitized: true,\n    consentValidated: true,\n    injectionCheckPassed: true\n  },\n  \n  // Error tracking\n  error: false,\n  errorMessages: [],\n  \n  // Performance optimization flag\n  useCache: priority === \"standard\",\n  \n  // Audit trail\n  auditLog: [{\n    timestamp: new Date().toISOString(),\n    action: \"workflow_initiated\",\n    details: \"Form submission validated and processed\"\n  }]\n};\n\nreturn [{\n  json: dataEnvelope\n}];"
      },
      "id": "data-normalizer-v3",
      "name": "Data Normalizer & Validator v3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.error}}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-validation-errors",
      "name": "Check Validation Errors",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "jsCode": "// Prepare context for API call - preserves all data\nconst data = $input.first().json;\n\n// Add to audit log\ndata.auditLog.push({\n  timestamp: new Date().toISOString(),\n  action: \"api_call_preparation\",\n  details: \"Preparing for Gemini API call\"\n});\n\n// Create context object for API\nconst context = {\n  _envelope: data,  // Preserve entire envelope\n  apiRequest: {\n    clientBrief: data.clientBrief,\n    useCache: data.useCache,\n    priority: data.priority\n  }\n};\n\nreturn [{\n  json: context\n}];"
      },
      "id": "prep-api-context",
      "name": "Prepare API Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-goog-api-key",
              "value": "={{$env.GEMINI_API_KEY}}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "body": "={{JSON.stringify({\n  contents: [{\n    parts: [{\n      text: `You are an expert n8n workflow architect and builder. Analyze this request and create a complete, production-ready n8n workflow.\n\n**CLIENT BRIEF:**\n${$json.apiRequest.clientBrief}\n\n**REQUIREMENTS:**\n1. Extract key requirements and identify needed nodes\n2. Design the workflow architecture\n3. Generate complete n8n workflow JSON\n4. Include proper error handling\n5. Add data validation where needed\n6. Use best practices for expressions\n\n**OUTPUT FORMAT:**\nProvide your response in this exact JSON structure:\n{\n  \"requirements\": {\n    \"primaryGoal\": \"...\",\n    \"dataSources\": [],\n    \"processingSteps\": [],\n    \"outputDestinations\": [],\n    \"errorHandling\": \"...\",\n    \"constraints\": []\n  },\n  \"architecture\": {\n    \"pattern\": \"...\",\n    \"nodes\": [\n      {\"name\": \"...\", \"type\": \"...\", \"purpose\": \"...\"}\n    ],\n    \"dataFlow\": \"...\",\n    \"errorStrategy\": \"...\"\n  },\n  \"workflow\": {\n    \"name\": \"...\",\n    \"nodes\": [],\n    \"connections\": {},\n    \"settings\": {}\n  },\n  \"metadata\": {\n    \"estimatedNodes\": 0,\n    \"complexity\": \"low|medium|high\",\n    \"apiIntegrations\": [],\n    \"credentials\": []\n  }\n}\n\n**IMPORTANT:**\n- Generate valid n8n node configurations\n- Use correct expression syntax ({{}} for expressions)\n- Include proper error handling nodes\n- Add data validation where appropriate\n- Follow n8n best practices`\n    }]\n  }],\n  generationConfig: {\n    temperature: 0.7,\n    maxOutputTokens: 8192,\n    topP: 0.95,\n    topK: 40\n  },\n  safetySettings: [\n    {\n      category: \"HARM_CATEGORY_DANGEROUS_CONTENT\",\n      threshold: \"BLOCK_NONE\"\n    }\n  ]\n})}}",
        "options": {
          "timeout": 30000,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "gemini-unified-api",
      "name": "Gemini Unified API (Optimized)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-api-response",
      "name": "Merge API Response",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1100, 250]
    },
    {
      "parameters": {
        "jsCode": "// Process and validate Gemini response with enhanced error handling\nconst context = $input.all()[0].json._envelope;\nconst apiResponse = $input.all()[1].json;\n\n// Check for API errors\nif (apiResponse.error) {\n  context.error = true;\n  context.fatal = true;\n  context.errorMessages.push(`API Error: ${apiResponse.error.message || 'Unknown error'}`);\n  context.auditLog.push({\n    timestamp: new Date().toISOString(),\n    action: \"api_error\",\n    details: apiResponse.error\n  });\n  return [{json: context}];\n}\n\ntry {\n  // Extract Gemini response\n  const geminiText = apiResponse.candidates?.[0]?.content?.parts?.[0]?.text;\n  \n  if (!geminiText) {\n    throw new Error(\"No response from Gemini API\");\n  }\n  \n  // Parse response with multiple fallback strategies\n  let parsedResponse;\n  \n  // Try direct JSON parse\n  try {\n    parsedResponse = JSON.parse(geminiText);\n  } catch (e) {\n    // Try to extract JSON from markdown code blocks\n    const jsonMatch = geminiText.match(/```(?:json)?\\s*({[\\s\\S]*})\\s*```/);\n    if (jsonMatch) {\n      parsedResponse = JSON.parse(jsonMatch[1]);\n    } else {\n      // Try to find JSON object in text\n      const jsonStart = geminiText.indexOf('{');\n      const jsonEnd = geminiText.lastIndexOf('}');\n      if (jsonStart >= 0 && jsonEnd > jsonStart) {\n        parsedResponse = JSON.parse(geminiText.substring(jsonStart, jsonEnd + 1));\n      } else {\n        throw new Error(\"Could not extract valid JSON from response\");\n      }\n    }\n  }\n  \n  // Validate response structure\n  if (!parsedResponse.workflow || !parsedResponse.workflow.nodes) {\n    throw new Error(\"Invalid workflow structure in response\");\n  }\n  \n  // Enhance workflow with security and optimization features\n  const enhancedWorkflow = {\n    ...parsedResponse.workflow,\n    name: parsedResponse.workflow.name || \"Generated Workflow\",\n    settings: {\n      ...parsedResponse.workflow.settings,\n      executionOrder: \"v1\",\n      saveManualExecutions: true,\n      saveDataErrorExecution: \"all\",\n      saveDataSuccessExecution: \"all\",\n      saveExecutionProgress: true,\n      maxExecutionDuration: 900, // 15 minutes\n      errorWorkflow: \"\",\n      timezone: \"UTC\"\n    },\n    staticData: {},\n    tags: [],\n    pinData: {},\n    versionId: \"v3.0\"\n  };\n  \n  // Add to context\n  context.parsedRequirements = parsedResponse.requirements;\n  context.architectureDesign = parsedResponse.architecture;\n  context.workflowJson = enhancedWorkflow;\n  context.workflowMetadata = parsedResponse.metadata;\n  context.processingStages.push(\"api-processing\");\n  \n  // Create workflow summary\n  context.workflowSummary = `\n    <div style=\"padding: 20px; background: #f5f5f5; border-radius: 8px; margin: 20px 0;\">\n      <h3>Workflow Summary</h3>\n      <p><strong>Name:</strong> ${enhancedWorkflow.name}</p>\n      <p><strong>Nodes:</strong> ${enhancedWorkflow.nodes.length}</p>\n      <p><strong>Complexity:</strong> ${parsedResponse.metadata?.complexity || 'unknown'}</p>\n      <p><strong>Pattern:</strong> ${parsedResponse.architecture?.pattern || 'custom'}</p>\n    </div>\n  `;\n  \n  // Add to audit log\n  context.auditLog.push({\n    timestamp: new Date().toISOString(),\n    action: \"workflow_generated\",\n    details: `Generated workflow with ${enhancedWorkflow.nodes.length} nodes`\n  });\n  \n} catch (error) {\n  context.error = true;\n  context.errorMessages.push(`Processing Error: ${error.message}`);\n  context.auditLog.push({\n    timestamp: new Date().toISOString(),\n    action: \"processing_error\",\n    details: error.message\n  });\n}\n\nreturn [{json: context}];"
      },
      "id": "process-api-response",
      "name": "Process API Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 250]
    },
    {
      "parameters": {
        "jsCode": "// Load knowledge base patterns and best practices\nconst context = $input.first().json;\n\n// Simulated KB data (in production, load from database)\nconst knowledgeBase = {\n  patterns: {\n    webhook: \"Webhook ‚Üí Process ‚Üí Response\",\n    scheduled: \"Schedule ‚Üí Fetch ‚Üí Process ‚Üí Store\",\n    eventDriven: \"Trigger ‚Üí Validate ‚Üí Process ‚Üí Notify\",\n    etl: \"Extract ‚Üí Transform ‚Üí Load\",\n    api: \"Request ‚Üí Authenticate ‚Üí Call ‚Üí Handle Response\"\n  },\n  bestPractices: [\n    \"Always use continueOnFail for external API calls\",\n    \"Implement proper error handling branches\",\n    \"Use environment variables for credentials\",\n    \"Add data validation before processing\",\n    \"Include logging for debugging\",\n    \"Set appropriate timeouts for HTTP requests\",\n    \"Use proper expression syntax\"\n  ],\n  commonErrors: [\n    \"Using hardcoded credentials\",\n    \"Missing error handling\",\n    \"Incorrect expression syntax\",\n    \"No data validation\",\n    \"Circular dependencies\"\n  ],\n  nodeCompatibility: {\n    \"n8n-nodes-base.httpRequest\": \"4.2\",\n    \"n8n-nodes-base.code\": \"2\",\n    \"n8n-nodes-base.if\": \"2\",\n    \"n8n-nodes-base.merge\": \"3\"\n  }\n};\n\n// Add KB data to context\ncontext.knowledgeBase = knowledgeBase;\ncontext.processingStages.push(\"knowledge-base-loaded\");\ncontext.auditLog.push({\n  timestamp: new Date().toISOString(),\n  action: \"kb_loaded\",\n  details: \"Knowledge base patterns and best practices loaded\"\n});\n\nreturn [{json: context}];"
      },
      "id": "load-knowledge-base",
      "name": "Load Knowledge Base",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 250]
    },
    {
      "parameters": {
        "jsCode": "// Prepare context for QA validation\nconst context = $input.first().json;\n\n// Skip QA if there was an error\nif (context.error) {\n  return [{json: context}];\n}\n\n// Prepare QA request\ncontext.qaRequest = {\n  workflow: context.workflowJson,\n  requirements: context.parsedRequirements,\n  knowledgeBase: context.knowledgeBase\n};\n\ncontext.auditLog.push({\n  timestamp: new Date().toISOString(),\n  action: \"qa_preparation\",\n  details: \"Preparing for QA validation\"\n});\n\nreturn [{json: context}];"
      },
      "id": "prep-qa-context",
      "name": "Prepare QA Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 250]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-goog-api-key",
              "value": "={{$env.GEMINI_API_KEY}}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "body": "={{JSON.stringify({\n  contents: [{\n    parts: [{\n      text: `You are an n8n workflow QA specialist. Validate this workflow for issues and best practices.\n\n**WORKFLOW TO VALIDATE:**\n${JSON.stringify($json.qaRequest.workflow, null, 2)}\n\n**VALIDATION CHECKLIST:**\n1. All node IDs are unique\n2. All nodes have positions\n3. All connections reference valid nodes\n4. Required fields are present\n5. No hardcoded credentials\n6. Error handling is implemented\n7. Expression syntax is correct\n8. No circular dependencies\n9. Data flow is logical\n10. Best practices are followed\n\n**KNOWLEDGE BASE PATTERNS:**\n${JSON.stringify($json.qaRequest.knowledgeBase.patterns)}\n\n**BEST PRACTICES:**\n${$json.qaRequest.knowledgeBase.bestPractices.join('\\n')}\n\n**OUTPUT FORMAT:**\n{\n  \"valid\": true/false,\n  \"issues\": [\n    {\"severity\": \"critical|high|medium|low\", \"message\": \"...\", \"node\": \"...\"}\n  ],\n  \"suggestions\": [],\n  \"score\": 0-100,\n  \"summary\": \"...\",\n  \"correctedWorkflow\": {} // Only if corrections needed\n}`\n    }]\n  }],\n  generationConfig: {\n    temperature: 0.3,\n    maxOutputTokens: 4096,\n    topP: 0.95,\n    topK: 40\n  }\n})}}",
        "options": {
          "timeout": 20000,
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "qa-validator-api",
      "name": "QA Validator API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1900, 250],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "merge-qa-response",
      "name": "Merge QA Response",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2100, 300]
    },
    {
      "parameters": {
        "jsCode": "// Process QA validation results\nconst context = $input.all()[0].json;\nconst qaResponse = $input.all()[1].json;\n\n// Skip if previous error\nif (context.error && context.fatal) {\n  return [{json: context}];\n}\n\ntry {\n  // Extract QA response\n  const qaText = qaResponse.candidates?.[0]?.content?.parts?.[0]?.text;\n  \n  if (!qaText) {\n    // QA failed but not fatal\n    context.qaResults = {\n      valid: true,\n      issues: [],\n      suggestions: [\"QA validation could not be completed\"],\n      score: 75,\n      summary: \"Workflow generated successfully but QA validation skipped\"\n    };\n  } else {\n    // Parse QA results\n    let qaResults;\n    try {\n      qaResults = JSON.parse(qaText);\n    } catch (e) {\n      // Try to extract from markdown\n      const jsonMatch = qaText.match(/```(?:json)?\\s*({[\\s\\S]*})\\s*```/);\n      if (jsonMatch) {\n        qaResults = JSON.parse(jsonMatch[1]);\n      } else {\n        throw new Error(\"Could not parse QA results\");\n      }\n    }\n    \n    context.qaResults = qaResults;\n    \n    // Use corrected workflow if provided\n    if (qaResults.correctedWorkflow && Object.keys(qaResults.correctedWorkflow).length > 0) {\n      context.workflowJson = qaResults.correctedWorkflow;\n      context.workflowCorrected = true;\n    }\n    \n    // Set QA validation status\n    context.qaValidationFailed = !qaResults.valid;\n    \n    // Add critical issues to error messages\n    if (qaResults.issues) {\n      const criticalIssues = qaResults.issues.filter(i => i.severity === \"critical\");\n      if (criticalIssues.length > 0) {\n        context.errorMessages.push(...criticalIssues.map(i => i.message));\n      }\n    }\n  }\n  \n  // Create QA report HTML\n  context.qaHtml = `\n    <div style=\"padding: 20px; background: ${context.qaResults.valid ? '#e7f5e7' : '#fff3cd'}; border-radius: 8px; margin: 20px 0;\">\n      <h3>QA Validation Report</h3>\n      <p><strong>Status:</strong> ${context.qaResults.valid ? '‚úÖ Passed' : '‚ö†Ô∏è Issues Found'}</p>\n      <p><strong>Score:</strong> ${context.qaResults.score || 0}/100</p>\n      <p><strong>Summary:</strong> ${context.qaResults.summary || 'No summary available'}</p>\n      ${context.qaResults.issues && context.qaResults.issues.length > 0 ? \n        '<h4>Issues:</h4><ul>' + context.qaResults.issues.map(i => \n          `<li>[${i.severity.toUpperCase()}] ${i.message}</li>`\n        ).join('') + '</ul>' : ''\n      }\n      ${context.qaResults.suggestions && context.qaResults.suggestions.length > 0 ?\n        '<h4>Suggestions:</h4><ul>' + context.qaResults.suggestions.map(s =>\n          `<li>${s}</li>`\n        ).join('') + '</ul>' : ''\n      }\n    </div>\n  `;\n  \n  context.processingStages.push(\"qa-validation\");\n  context.auditLog.push({\n    timestamp: new Date().toISOString(),\n    action: \"qa_completed\",\n    details: `QA validation completed with score ${context.qaResults.score}`\n  });\n  \n} catch (error) {\n  // QA error but not fatal\n  context.qaResults = {\n    valid: true,\n    issues: [],\n    suggestions: [],\n    score: 70,\n    summary: \"QA validation encountered an error but workflow is likely valid\"\n  };\n  \n  context.auditLog.push({\n    timestamp: new Date().toISOString(),\n    action: \"qa_error\",\n    details: error.message\n  });\n}\n\nreturn [{json: context}];"
      },
      "id": "process-qa-results",
      "name": "Process QA Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2300, 300]
    },
    {
      "parameters": {
        "jsCode": "// Performance optimization: Implement caching\nconst context = $input.first().json;\n\n// Skip caching for high priority requests\nif (context.priority === \"high\" || !context.useCache) {\n  return [{json: context}];\n}\n\n// Simple in-memory cache simulation (in production, use Redis)\nconst cacheKey = `workflow_${Buffer.from(context.clientBrief).toString('base64').substring(0, 20)}`;\n\n// Check cache (simulated)\nconst cachedWorkflow = null; // In production, check Redis\n\nif (cachedWorkflow) {\n  context.workflowJson = cachedWorkflow;\n  context.cacheHit = true;\n  context.processingStages.push(\"cache-hit\");\n  context.auditLog.push({\n    timestamp: new Date().toISOString(),\n    action: \"cache_hit\",\n    details: `Retrieved workflow from cache: ${cacheKey}`\n  });\n} else {\n  // Store in cache for future use\n  context.cacheKey = cacheKey;\n  context.cacheHit = false;\n  context.processingStages.push(\"cache-miss\");\n}\n\nreturn [{json: context}];"
      },
      "id": "cache-manager",
      "name": "Cache Manager (Performance)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2500, 300]
    },
    {
      "parameters": {
        "jsCode": "// Audit logging for GDPR compliance\nconst context = $input.first().json;\n\n// Create comprehensive audit record\nconst auditRecord = {\n  workflowId: context.workflowId,\n  timestamp: context.timestamp,\n  clientEmail: context.clientEmail,\n  organization: context.organization,\n  gdprConsent: context.gdprConsent,\n  processingStages: context.processingStages,\n  error: context.error,\n  errorMessages: context.errorMessages,\n  qaScore: context.qaResults?.score || 0,\n  cacheHit: context.cacheHit || false,\n  executionTime: Date.now() - new Date(context.timestamp).getTime(),\n  dataRetentionDays: context.retentionDays,\n  auditLog: context.auditLog\n};\n\n// In production, store in PostgreSQL\n// For now, just add to context\ncontext.auditRecord = auditRecord;\ncontext.processingStages.push(\"audit-logged\");\n\n// Add final audit entry\ncontext.auditLog.push({\n  timestamp: new Date().toISOString(),\n  action: \"processing_complete\",\n  details: `Workflow processing completed in ${auditRecord.executionTime}ms`\n});\n\nreturn [{json: context}];"
      },
      "id": "audit-logger",
      "name": "Audit Logger (GDPR)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2700, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.error && $json.fatal}}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-for-errors",
      "name": "Check for Errors",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2900, 300]
    },
    {
      "parameters": {
        "jsCode": "// Build secure success email with HTML escaping\nconst context = $input.first().json;\n\nfunction escapeHtml(text) {\n  if (!text) return '';\n  return String(text)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nconst safeClientBrief = escapeHtml(context.clientBrief);\nconst safeOrganization = escapeHtml(context.organization);\n\n// Determine subject based on QA results\nlet subject = \"Your n8n Workflow is Ready\";\nif (context.qaValidationFailed) {\n  subject = \"Your n8n Workflow (with warnings)\";\n} else if (context.qaResults?.score >= 90) {\n  subject = \"Your n8n Workflow is Ready (High Quality)\";\n}\n\n// Build comprehensive email\nconst emailHtml = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }\n    .section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }\n    .metadata { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }\n    .metadata-item { padding: 10px; background: white; border-radius: 5px; }\n    .code-block { background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto; }\n    .button { display: inline-block; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 10px 0; }\n    .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }\n    .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <h1>üéâ Your n8n Workflow is Ready!</h1>\n    <p>Generated by n8n Workflow Builder v3.0 - Enterprise Edition</p>\n  </div>\n  \n  <div class=\"section\">\n    <h2>üìã Request Details</h2>\n    <div class=\"metadata\">\n      <div class=\"metadata-item\">\n        <strong>Workflow ID:</strong> ${context.workflowId}\n      </div>\n      <div class=\"metadata-item\">\n        <strong>Generated:</strong> ${new Date(context.timestamp).toLocaleString()}\n      </div>\n      <div class=\"metadata-item\">\n        <strong>Organization:</strong> ${safeOrganization || 'Not specified'}\n      </div>\n      <div class=\"metadata-item\">\n        <strong>Priority:</strong> ${context.priority}\n      </div>\n      <div class=\"metadata-item\">\n        <strong>Processing Time:</strong> ${context.auditRecord?.executionTime || 0}ms\n      </div>\n      <div class=\"metadata-item\">\n        <strong>Cache Status:</strong> ${context.cacheHit ? 'HIT ‚ö°' : 'MISS'}\n      </div>\n    </div>\n  </div>\n  \n  <div class=\"section\">\n    <h2>üìù Your Brief</h2>\n    <p>${safeClientBrief}</p>\n  </div>\n  \n  ${context.workflowSummary || ''}\n  \n  ${context.qaHtml || ''}\n  \n  <div class=\"section\">\n    <h2>üíæ Workflow JSON</h2>\n    <p>Copy the JSON below and import it into your n8n instance:</p>\n    <div class=\"code-block\">\n      <pre>${escapeHtml(JSON.stringify(context.workflowJson, null, 2))}</pre>\n    </div>\n    <a href=\"#\" class=\"button\" onclick=\"navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(context.workflowJson).replace(/\"/g, '&quot;')})); alert('Copied to clipboard!'); return false;\">üìã Copy to Clipboard</a>\n  </div>\n  \n  <div class=\"section\">\n    <h2>üöÄ Next Steps</h2>\n    <ol>\n      <li>Copy the workflow JSON above</li>\n      <li>Open your n8n instance</li>\n      <li>Go to Workflows ‚Üí Import from File/URL</li>\n      <li>Paste the JSON and click Import</li>\n      <li>Configure any required credentials</li>\n      <li>Test and activate your workflow</li>\n    </ol>\n  </div>\n  \n  <div class=\"footer\">\n    <p><strong>Data Retention:</strong> This workflow data will be retained for ${context.retentionDays} days as per our privacy policy.</p>\n    <p><strong>GDPR Compliance:</strong> Your consent was recorded at ${new Date(context.gdprConsent.timestamp).toLocaleString()}.</p>\n    <p><strong>Support:</strong> If you need assistance, please reply to this email with your Workflow ID: ${context.workflowId}</p>\n    <p style=\"margin-top: 20px; font-size: 0.8em;\">¬© 2025 n8n Workflow Builder v3.0 | Secure ‚Ä¢ Optimized ‚Ä¢ Compliant</p>\n  </div>\n</body>\n</html>`;\n\ncontext.emailSubject = subject;\ncontext.emailHtml = emailHtml;\ncontext.emailTo = context.clientEmail;\n\nreturn [{json: context}];"
      },
      "id": "build-success-email",
      "name": "Build Success Email (Secure)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3100, 200]
    },
    {
      "parameters": {
        "jsCode": "// Build secure error email\nconst context = $input.first().json;\n\nfunction escapeHtml(text) {\n  if (!text) return '';\n  return String(text)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nconst errorMessages = context.errorMessages || [];\nconst lastError = errorMessages[errorMessages.length - 1] || 'Unknown error occurred';\n\nconst emailHtml = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <style>\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }\n    .error-box { background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px; margin: 20px 0; }\n    .section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; font-size: 0.9em; color: #6c757d; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <h1>‚ö†Ô∏è Workflow Generation Issue</h1>\n    <p>We encountered an issue processing your request</p>\n  </div>\n  \n  <div class=\"error-box\">\n    <h2>Error Details</h2>\n    <p><strong>Workflow ID:</strong> ${escapeHtml(context.workflowId)}</p>\n    <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>\n    <p><strong>Stage:</strong> ${escapeHtml(context.processingStages[context.processingStages.length - 1] || 'unknown')}</p>\n    <p><strong>Error Messages:</strong></p>\n    <ul>\n      ${errorMessages.map(msg => `<li>${escapeHtml(msg)}</li>`).join('')}\n    </ul>\n  </div>\n  \n  <div class=\"section\">\n    <h2>What You Can Do</h2>\n    <ol>\n      <li>Review your workflow description for clarity</li>\n      <li>Ensure your request doesn't exceed 5000 characters</li>\n      <li>Try simplifying complex requirements</li>\n      <li>Wait a few minutes and try again</li>\n    </ol>\n  </div>\n  \n  <div class=\"section\">\n    <h2>Need Help?</h2>\n    <p>If this issue persists, please contact support with your Workflow ID: <strong>${escapeHtml(context.workflowId)}</strong></p>\n  </div>\n  \n  <div class=\"footer\">\n    <p>¬© 2025 n8n Workflow Builder v3.0</p>\n  </div>\n</body>\n</html>`;\n\ncontext.emailSubject = \"Workflow Generation Issue - Action Required\";\ncontext.emailHtml = emailHtml;\ncontext.emailTo = context.clientEmail;\n\nreturn [{json: context}];"
      },
      "id": "build-error-email",
      "name": "Build Error Email (Secure)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3100, 400]
    },
    {
      "parameters": {
        "operation": "send",
        "sendTo": "={{$json.emailTo}}",
        "subject": "={{$json.emailSubject}}",
        "message": "={{$json.emailHtml}}",
        "options": {
          "appendAttribution": false,
          "allowUnauthorizedCerts": false
        }
      },
      "id": "send-email",
      "name": "Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [3300, 300],
      "credentials": {
        "gmailOAuth2": {
          "id": "{{$env.GMAIL_CREDENTIAL_ID}}",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Schedule data deletion for GDPR compliance\nconst context = $input.first().json;\n\n// Calculate deletion date\nconst deletionDate = new Date();\ndeletionDate.setDate(deletionDate.getDate() + context.retentionDays);\n\n// Create deletion task (in production, store in database)\nconst deletionTask = {\n  workflowId: context.workflowId,\n  clientEmail: context.clientEmail,\n  scheduledDeletion: deletionDate.toISOString(),\n  dataCategories: [\n    'workflow_json',\n    'client_brief',\n    'audit_logs',\n    'email_content'\n  ],\n  status: 'scheduled'\n};\n\n// Log deletion scheduling\ncontext.deletionScheduled = true;\ncontext.deletionDate = deletionDate.toISOString();\ncontext.auditLog.push({\n  timestamp: new Date().toISOString(),\n  action: \"deletion_scheduled\",\n  details: `Data deletion scheduled for ${deletionDate.toISOString()}`\n});\n\nreturn [{json: context}];"
      },
      "id": "schedule-deletion",
      "name": "Schedule Data Deletion (GDPR)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3500, 300]
    }
  ],
  "connections": {
    "form-trigger-v3": {
      "main": [
        [
          {
            "node": "data-normalizer-v3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "data-normalizer-v3": {
      "main": [
        [
          {
            "node": "check-validation-errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-validation-errors": {
      "main": [
        [
          {
            "node": "prep-api-context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "build-error-email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prep-api-context": {
      "main": [
        [
          {
            "node": "gemini-unified-api",
            "type": "main",
            "index": 0
          },
          {
            "node": "merge-api-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "gemini-unified-api": {
      "main": [
        [
          {
            "node": "merge-api-response",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge-api-response": {
      "main": [
        [
          {
            "node": "process-api-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-api-response": {
      "main": [
        [
          {
            "node": "load-knowledge-base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "load-knowledge-base": {
      "main": [
        [
          {
            "node": "prep-qa-context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prep-qa-context": {
      "main": [
        [
          {
            "node": "qa-validator-api",
            "type": "main",
            "index": 0
          },
          {
            "node": "merge-qa-response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "qa-validator-api": {
      "main": [
        [
          {
            "node": "merge-qa-response",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "merge-qa-response": {
      "main": [
        [
          {
            "node": "process-qa-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-qa-results": {
      "main": [
        [
          {
            "node": "cache-manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cache-manager": {
      "main": [
        [
          {
            "node": "audit-logger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "audit-logger": {
      "main": [
        [
          {
            "node": "check-for-errors",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-for-errors": {
      "main": [
        [
          {
            "node": "build-success-email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "build-error-email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build-success-email": {
      "main": [
        [
          {
            "node": "send-email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "build-error-email": {
      "main": [
        [
          {
            "node": "send-email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "send-email": {
      "main": [
        [
          {
            "node": "schedule-deletion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "schedule-deletion": {
      "main": [[]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveExecutionProgress": true,
    "maxExecutionDuration": 900,
    "errorWorkflow": "",
    "timezone": "UTC"
  },
  "staticData": {},
  "tags": [
    {
      "name": "production",
      "createdAt": "2025-11-17T12:00:00.000Z"
    },
    {
      "name": "v3.0",
      "createdAt": "2025-11-17T12:00:00.000Z"
    },
    {
      "name": "master",
      "createdAt": "2025-11-17T12:00:00.000Z"
    }
  ],
  "triggerCount": 1,
  "versionId": "3.0.0-master",
  "id": "workflow-builder-v3-master",
  "meta": {
    "templateId": "workflow-builder-v3-master",
    "instanceId": "production"
  },
  "active": false,
  "createdAt": "2025-11-17T12:00:00.000Z",
  "updatedAt": "2025-11-17T12:00:00.000Z"
}